name: Build PostmarketOS for NX669S

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y wget python3 cpio gzip unzip
        git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg mkbootimg-tools
        
    - name: Download OrangeFox Recovery
      run: |
        # Download OrangeFox which has working kernel
        wget -q "https://github.com/piashgit/halium_device_nubia_NX669S/releases/download/orangefox-kernel/orangefox.img" -O orangefox.img || \
        wget --no-check-certificate -q "https://sourceforge.net/projects/nicofee-nicofee/files/NX669J/OrangeFox-12.1-Unofficial-Dr.Brown-NX669J.img/download" -O orangefox.img || \
        exit 1
        
        ls -la orangefox.img
        
    - name: Extract kernel
      run: |
        python3 mkbootimg-tools/unpack_bootimg.py --boot_img orangefox.img --out extracted
        cp extracted/kernel kernel
        ls -la kernel
        
    - name: Download Alpine rootfs
      run: |
        wget -q "https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/aarch64/alpine-minirootfs-3.19.0-aarch64.tar.gz" -O alpine.tar.gz
        mkdir -p alpine-rootfs
        tar -xzf alpine.tar.gz -C alpine-rootfs
        
    - name: Create PostmarketOS initramfs
      run: |
        mkdir -p pmos-ramdisk/{bin,sbin,dev,proc,sys,tmp,run,config,mnt,etc}
        
        # Download busybox arm64
        wget -q "https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-armv8l" -O pmos-ramdisk/bin/busybox
        chmod +x pmos-ramdisk/bin/busybox
        
        # Symlinks
        cd pmos-ramdisk/bin
        for cmd in sh ash cat cp dd echo ls mkdir mount umount ln rm sleep switch_root mknod chmod chown ifconfig; do
          ln -sf busybox $cmd
        done
        cd ../sbin
        for cmd in sh init mount umount switch_root; do
          ln -sf ../bin/busybox $cmd
        done
        cd ../..
        
        # Init script
        cat > pmos-ramdisk/init << 'INITSCRIPT'
        #!/bin/sh
        export PATH=/sbin:/bin
        
        mount -t proc proc /proc
        mount -t sysfs sysfs /sys
        mount -t devtmpfs devtmpfs /dev
        mount -t tmpfs tmpfs /tmp
        mount -t tmpfs tmpfs /run
        mkdir -p /config
        mount -t configfs none /config 2>/dev/null
        
        echo "=== PostmarketOS NX669S ===" > /dev/kmsg
        
        # USB Peripheral mode
        echo "peripheral" > /sys/bus/platform/devices/a600000.ssusb/mode 2>/dev/null
        
        sleep 1
        
        # USB Gadget RNDIS
        USB=/config/usb_gadget/g1
        mkdir -p $USB/strings/0x409 $USB/functions/rndis.usb0 $USB/configs/c.1/strings/0x409
        echo 0x18D1 > $USB/idVendor
        echo 0x4EE0 > $USB/idProduct
        echo "PostmarketOS" > $USB/strings/0x409/manufacturer
        echo "NX669S" > $USB/strings/0x409/product
        echo "pmos" > $USB/configs/c.1/strings/0x409/configuration
        ln -sf $USB/functions/rndis.usb0 $USB/configs/c.1/ 2>/dev/null
        UDC=$(ls /sys/class/udc/ 2>/dev/null | head -1)
        [ -n "$UDC" ] && echo "$UDC" > $USB/UDC
        
        sleep 2
        
        ifconfig usb0 172.16.42.1 netmask 255.255.255.0 2>/dev/null
        ifconfig rndis0 172.16.42.1 netmask 255.255.255.0 2>/dev/null
        
        /bin/busybox telnetd -l /bin/sh -p 23 &
        
        echo "Telnet: 172.16.42.1:23" > /dev/kmsg
        
        # Mount userdata
        mkdir -p /mnt/data
        mount /dev/block/bootdevice/by-name/userdata /mnt/data -t f2fs 2>/dev/null
        
        # Check for pmos rootfs
        if [ -f /mnt/data/pmos-rootfs.img ]; then
          echo "Found PostmarketOS rootfs" > /dev/kmsg
          mkdir -p /mnt/pmos
          mount -o loop /mnt/data/pmos-rootfs.img /mnt/pmos
          if [ -d /mnt/pmos/bin ]; then
            mount --bind /dev /mnt/pmos/dev
            mount --bind /sys /mnt/pmos/sys
            mount --bind /proc /mnt/pmos/proc
            echo "Switching to PostmarketOS..." > /dev/kmsg
            exec switch_root /mnt/pmos /sbin/init
          fi
        fi
        
        echo "Shell ready via telnet" > /dev/kmsg
        exec /bin/sh
        INITSCRIPT
        
        chmod +x pmos-ramdisk/init
        
        cd pmos-ramdisk
        find . | cpio -o -H newc 2>/dev/null | gzip > ../pmos-ramdisk.cpio.gz
        cd ..
        ls -la pmos-ramdisk.cpio.gz
        
    - name: Create boot image
      run: |
        python3 mkbootimg-tools/mkbootimg.py \
          --kernel kernel \
          --ramdisk pmos-ramdisk.cpio.gz \
          --base 0x00000000 \
          --kernel_offset 0x00008000 \
          --ramdisk_offset 0x01000000 \
          --pagesize 4096 \
          --header_version 3 \
          --cmdline "androidboot.selinux=permissive" \
          --os_version 12.0.0 \
          --os_patch_level 2024-01 \
          -o postmarketos-nx669s.img
          
        truncate -s 100663296 postmarketos-nx669s.img
        ls -la postmarketos-nx669s.img
        
    - name: Create Alpine rootfs image
      run: |
        dd if=/dev/zero of=pmos-rootfs.img bs=1M count=512
        mkfs.ext4 -L pmos pmos-rootfs.img
        mkdir -p mnt
        sudo mount -o loop pmos-rootfs.img mnt
        sudo cp -a alpine-rootfs/* mnt/
        sudo mkdir -p mnt/etc/apk
        echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" | sudo tee mnt/etc/apk/repositories
        echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" | sudo tee -a mnt/etc/apk/repositories
        sudo umount mnt
        ls -la pmos-rootfs.img
        
    - name: Upload boot
      uses: actions/upload-artifact@v4
      with:
        name: postmarketos-nx669s-boot
        path: postmarketos-nx669s.img
        
    - name: Upload rootfs
      uses: actions/upload-artifact@v4
      with:
        name: postmarketos-nx669s-rootfs
        path: pmos-rootfs.img
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: pmos-v${{ github.run_number }}
        name: PostmarketOS NX669S v${{ github.run_number }}
        files: |
          postmarketos-nx669s.img
          pmos-rootfs.img
        body: |
          ## PostmarketOS for NX669S (Red Magic 6S Pro)
          
          Uses OrangeFox kernel (proven working) + Alpine Linux rootfs
          
          ### Installation:
          ```bash
          # Push rootfs
          adb push pmos-rootfs.img /data/
          
          # Boot
          fastboot boot postmarketos-nx669s.img
          
          # Connect (set PC to 172.16.42.2)
          telnet 172.16.42.1
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
