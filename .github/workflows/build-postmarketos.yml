name: Build PostmarketOS for NX669S

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl wget build-essential bc bison flex libssl-dev libelf-dev python3 python3-pip cpio gzip lz4 gcc-aarch64-linux-gnu device-tree-compiler libncurses-dev
        git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg mkbootimg-tools
        pip3 install pmbootstrap
        
    - name: Clone kernel source
      run: |
        # Use stock kernel (works with device)
        git clone --depth=1 -b lineage-20 https://github.com/piashgit/android_kernel_nubia_sm8350.git kernel-mainline
        
    - name: Configure kernel for PostmarketOS
      run: |
        cd kernel-mainline
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # Use device defconfig
        make O=out vendor/lahaina-qgki_defconfig
        
        cat >> out/.config << 'PMOSCONFIG'
        CONFIG_DEVTMPFS=y
        CONFIG_DEVTMPFS_MOUNT=y
        CONFIG_BLK_DEV_INITRD=y
        CONFIG_RD_GZIP=y
        CONFIG_TMPFS=y
        CONFIG_VT=y
        CONFIG_VT_CONSOLE=y
        CONFIG_EXT4_FS=y
        CONFIG_F2FS_FS=y
        PMOSCONFIG
        
        make O=out olddefconfig
        
    - name: Build kernel
      run: |
        cd kernel-mainline
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make O=out -j$(nproc) Image
        ls -la out/arch/arm64/boot/
        
    - name: Download PostmarketOS rootfs
      run: |
        # Download Alpine-based PostmarketOS rootfs
        mkdir -p pmos-rootfs
        wget -q "https://images.postmarketos.org/bpo/edge/qcom-sm8350/phosh/postmarketos-edge-qcom-sm8350-phosh.img.xz" -O pmos.img.xz || \
        wget -q "https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/aarch64/alpine-minirootfs-3.19.0-aarch64.tar.gz" -O alpine-rootfs.tar.gz
        
        if [ -f alpine-rootfs.tar.gz ]; then
          mkdir -p pmos-rootfs
          tar -xzf alpine-rootfs.tar.gz -C pmos-rootfs
        fi
        
    - name: Create PostmarketOS initramfs
      run: |
        mkdir -p pmos-initramfs/{bin,sbin,etc,proc,sys,dev,mnt,tmp,run,lib,usr/bin,usr/sbin}
        
        # Download busybox
        wget -q "https://www.busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox" -O pmos-initramfs/bin/busybox || \
        wget -q "https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-armv8l" -O pmos-initramfs/bin/busybox
        chmod +x pmos-initramfs/bin/busybox
        
        # Create symlinks
        cd pmos-initramfs/bin
        for cmd in sh ash cat cp dd echo ls mkdir mount umount ln rm sleep switch_root mknod chmod chown ifconfig ip; do
          ln -sf busybox $cmd
        done
        cd ../sbin
        for cmd in init mount umount switch_root mdev; do
          ln -sf ../bin/busybox $cmd
        done
        cd ../..
        
        # Create PostmarketOS init
        cat > pmos-initramfs/init << 'PMOSINIT'
        #!/bin/sh
        export PATH=/sbin:/bin:/usr/sbin:/usr/bin
        
        mount -t proc proc /proc
        mount -t sysfs sysfs /sys
        mount -t devtmpfs devtmpfs /dev
        mount -t tmpfs tmpfs /tmp
        mount -t tmpfs tmpfs /run
        
        # Parse cmdline
        for x in $(cat /proc/cmdline); do
          case "$x" in
            pmos_root=*) PMOS_ROOT="${x#pmos_root=}" ;;
            pmos_boot=*) PMOS_BOOT="${x#pmos_boot=}" ;;
          esac
        done
        
        echo "=== PostmarketOS NX669S ===" > /dev/kmsg
        
        # USB Peripheral mode for Qualcomm
        echo "peripheral" > /sys/bus/platform/devices/a600000.ssusb/mode 2>/dev/null
        
        # Setup USB network (RNDIS)
        mkdir -p /config
        mount -t configfs none /config 2>/dev/null
        
        USB=/config/usb_gadget/g1
        mkdir -p $USB
        echo 0x18D1 > $USB/idVendor
        echo 0x4EE0 > $USB/idProduct
        mkdir -p $USB/strings/0x409
        echo "PostmarketOS" > $USB/strings/0x409/manufacturer
        echo "NX669S" > $USB/strings/0x409/product
        mkdir -p $USB/functions/rndis.usb0
        mkdir -p $USB/configs/c.1/strings/0x409
        echo "rndis" > $USB/configs/c.1/strings/0x409/configuration
        ln -sf $USB/functions/rndis.usb0 $USB/configs/c.1/ 2>/dev/null
        UDC=$(ls /sys/class/udc/ | head -1)
        echo "$UDC" > $USB/UDC 2>/dev/null
        
        sleep 2
        
        # Setup network
        ifconfig usb0 172.16.42.1 netmask 255.255.255.0 2>/dev/null
        ifconfig rndis0 172.16.42.1 netmask 255.255.255.0 2>/dev/null
        
        # Telnet debug
        /bin/busybox telnetd -l /bin/sh -p 23 2>/dev/null &
        
        echo "Telnet: 172.16.42.1:23" > /dev/kmsg
        
        # Try mounting rootfs
        mkdir -p /mnt/root
        
        # Try userdata partition
        mount /dev/disk/by-partlabel/userdata /mnt/root -t f2fs 2>/dev/null || \
        mount /dev/block/by-name/userdata /mnt/root -t f2fs 2>/dev/null
        
        if [ -f /mnt/root/pmos-rootfs.img ]; then
          echo "Found PostmarketOS rootfs" > /dev/kmsg
          mkdir -p /mnt/pmos
          mount -o loop /mnt/root/pmos-rootfs.img /mnt/pmos
          
          if [ -x /mnt/pmos/sbin/init ]; then
            mount --move /dev /mnt/pmos/dev
            mount --move /proc /mnt/pmos/proc
            mount --move /sys /mnt/pmos/sys
            exec switch_root /mnt/pmos /sbin/init
          fi
        fi
        
        # Fallback shell
        echo "Dropping to shell..." > /dev/kmsg
        exec /bin/sh
        PMOSINIT
        
        chmod +x pmos-initramfs/init
        
        # Create initramfs
        cd pmos-initramfs
        find . | cpio -o -H newc 2>/dev/null | gzip > ../pmos-initramfs.cpio.gz
        cd ..
        ls -la pmos-initramfs.cpio.gz
        
    - name: Create boot image
      run: |
        KERNEL=kernel-mainline/out/arch/arm64/boot/Image
        
        python3 mkbootimg-tools/mkbootimg.py \
          --kernel $KERNEL \
          --ramdisk pmos-initramfs.cpio.gz \
          --base 0x00000000 \
          --kernel_offset 0x00008000 \
          --ramdisk_offset 0x01000000 \
          --pagesize 4096 \
          --header_version 3 \
          --cmdline "console=ttyMSM0,115200n8 pd_ignore_unused clk_ignore_unused pmos_boot=/dev/sda1 pmos_root=/dev/sda2" \
          --os_version 12.0.0 \
          --os_patch_level 2024-01 \
          -o postmarketos-nx669s.img
          
        truncate -s 100663296 postmarketos-nx669s.img
        ls -la postmarketos-nx669s.img
        
    - name: Create Alpine rootfs image
      run: |
        # Create minimal Alpine rootfs image
        dd if=/dev/zero of=pmos-rootfs.img bs=1M count=512
        mkfs.ext4 -L pmos pmos-rootfs.img
        
        mkdir -p mnt
        sudo mount -o loop pmos-rootfs.img mnt
        
        if [ -d pmos-rootfs ]; then
          sudo cp -a pmos-rootfs/* mnt/
        fi
        
        # Add postmarketOS packages list
        sudo mkdir -p mnt/etc/apk
        echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" | sudo tee mnt/etc/apk/repositories
        echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" | sudo tee -a mnt/etc/apk/repositories
        
        sudo umount mnt
        ls -la pmos-rootfs.img
        
    - name: Upload PostmarketOS boot
      uses: actions/upload-artifact@v4
      with:
        name: postmarketos-nx669s-boot
        path: postmarketos-nx669s.img
        
    - name: Upload PostmarketOS rootfs
      uses: actions/upload-artifact@v4
      with:
        name: postmarketos-nx669s-rootfs
        path: pmos-rootfs.img
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: pmos-v${{ github.run_number }}
        name: PostmarketOS NX669S v${{ github.run_number }}
        files: |
          postmarketos-nx669s.img
          pmos-rootfs.img
        body: |
          ## PostmarketOS for NX669S (Red Magic 6S Pro)
          
          ### Files:
          - `postmarketos-nx669s.img` - Boot image with mainline kernel
          - `pmos-rootfs.img` - Alpine Linux rootfs (512MB)
          
          ### Installation:
          1. Copy `pmos-rootfs.img` to device:
             ```
             adb push pmos-rootfs.img /sdcard/
             adb shell mv /sdcard/pmos-rootfs.img /data/
             ```
          
          2. Boot PostmarketOS:
             ```
             fastboot boot postmarketos-nx669s.img
             ```
          
          3. Connect via USB network:
             ```
             # Set PC IP to 172.16.42.2
             telnet 172.16.42.1
             ```
          
          ### Features:
          - Mainline Linux kernel
          - USB RNDIS network
          - Telnet debug shell
          - Alpine Linux base
          
          ### Status:
          - USB: Should work
          - Display: Simple framebuffer (may need tuning)
          - Touch: Untested
          - WiFi/BT: Not working (needs firmware)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
