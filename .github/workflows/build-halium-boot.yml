name: Build Halium Boot

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel branch to use'
        required: false
        default: 'lineage-20'
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout device tree
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl wget build-essential bc bison flex libssl-dev libelf-dev python3 python3-pip cpio gzip lz4 device-tree-compiler gcc-aarch64-linux-gnu crossbuild-essential-arm64 busybox-static
        git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg mkbootimg-tools
        chmod +x mkbootimg-tools/*.py
        
    - name: Clone kernel source
      run: git clone --depth=1 -b ${{ github.event.inputs.kernel_branch || 'lineage-20' }} https://github.com/piashgit/android_kernel_nubia_sm8350 kernel
          
    - name: Setup Halium initramfs
      run: |
        mkdir -p ramdisk/{dev,proc,sys,system,data,vendor,sbin,bin,lib,etc,mnt,tmp}
        mkdir -p ramdisk/mnt/system
        cp /bin/busybox ramdisk/bin/
        chmod +x ramdisk/bin/busybox
        cd ramdisk/bin && for cmd in sh ash cat cp dd echo ls mkdir mount umount ln rm sleep switch_root; do ln -sf busybox $cmd; done && cd ../..
        cd ramdisk/sbin && for cmd in sh mount umount switch_root; do ln -sf ../bin/busybox $cmd; done && cd ../..
        echo '#!/bin/sh' > ramdisk/init
        echo 'export PATH=/sbin:/bin:/usr/sbin:/usr/bin' >> ramdisk/init
        echo 'mount -t proc proc /proc' >> ramdisk/init
        echo 'mount -t sysfs sysfs /sys' >> ramdisk/init
        echo 'mount -t devtmpfs devtmpfs /dev' >> ramdisk/init
        echo 'mount -t tmpfs tmpfs /tmp' >> ramdisk/init
        echo 'sleep 2' >> ramdisk/init
        echo 'echo "Halium boot: NX669S"' >> ramdisk/init
        echo 'if [ -e /dev/block/by-name/system_a ]; then mount -o ro /dev/block/by-name/system_a /mnt/system; elif [ -e /dev/block/by-name/system ]; then mount -o ro /dev/block/by-name/system /mnt/system; fi' >> ramdisk/init
        echo 'if [ -d /mnt/system/ubuntu ]; then exec switch_root /mnt/system/ubuntu /sbin/init; fi' >> ramdisk/init
        echo 'if [ -f /mnt/system/sbin/init ]; then exec switch_root /mnt/system /sbin/init; fi' >> ramdisk/init
        echo 'echo "No rootfs found, dropping to shell..."' >> ramdisk/init
        echo 'exec /bin/sh' >> ramdisk/init
        chmod +x ramdisk/init
        echo "proc /proc proc defaults 0 0" > ramdisk/etc/fstab
        echo "=== Ramdisk contents ===" && find ramdisk -type f && du -sh ramdisk/
        
    - name: Build kernel
      run: |
        cd kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        ls arch/arm64/configs/vendor/ | grep -i lahaina | head -5
        if [ -f arch/arm64/configs/vendor/lahaina-qgki_defconfig ]; then make O=out vendor/lahaina-qgki_defconfig; else make O=out defconfig; fi
        echo "CONFIG_VT=y" >> out/.config
        echo "CONFIG_DEVTMPFS=y" >> out/.config
        echo "CONFIG_DEVTMPFS_MOUNT=y" >> out/.config
        echo "CONFIG_TMPFS=y" >> out/.config
        echo "CONFIG_ANDROID_BINDER_IPC=y" >> out/.config
        make O=out -j$(nproc) Image
        ls -la out/arch/arm64/boot/
        
    - name: Create Halium boot image
      run: |
        cd ramdisk && find . | cpio -o -H newc 2>/dev/null | gzip > ../ramdisk.cpio.gz && cd ..
        ls -la ramdisk.cpio.gz
        KERNEL=kernel/out/arch/arm64/boot/Image
        ls -la $KERNEL
        python3 mkbootimg-tools/mkbootimg.py --kernel $KERNEL --ramdisk ramdisk.cpio.gz --base 0x00000000 --kernel_offset 0x00008000 --ramdisk_offset 0x01000000 --pagesize 4096 --header_version 3 --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 msm_rtb.filter=0x237 service_locator.enable=1 androidboot.usbcontroller=a600000.dwc3 swiotlb=0 loop.max_part=7 cgroup.memory=nokmem,nosocket androidboot.selinux=permissive" --os_version 12.0.0 --os_patch_level 2024-01 -o halium-boot-nx669s.img
        ls -la halium-boot-nx669s.img
        file halium-boot-nx669s.img
        
    - name: Upload Halium boot image
      uses: actions/upload-artifact@v4
      with:
        name: halium-boot-nx669s
        path: halium-boot-nx669s.img
        
    - name: Create Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: halium-boot-${{ github.run_number }}
        name: Halium Boot NX669S Build ${{ github.run_number }}
        files: halium-boot-nx669s.img
        body: |
          ## Halium Boot for NX669S
          - Kernel: ${{ github.event.inputs.kernel_branch || 'lineage-20' }}
          - Flash: fastboot flash boot halium-boot-nx669s.img
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
