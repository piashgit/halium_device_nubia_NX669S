name: Build Halium Boot

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel branch to use'
        required: false
        default: 'lineage-20'
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout device tree
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git curl wget \
          build-essential bc bison flex libssl-dev \
          libelf-dev python3 python3-pip \
          cpio gzip lz4 \
          device-tree-compiler gcc-aarch64-linux-gnu \
          crossbuild-essential-arm64 busybox-static
        
        git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg mkbootimg-tools
        chmod +x mkbootimg-tools/*.py
        
    - name: Clone kernel source
      run: |
        git clone --depth=1 -b ${{ github.event.inputs.kernel_branch || 'lineage-20' }} \
          https://github.com/piashgit/android_kernel_nubia_sm8350 kernel
          
    - name: Setup Halium initramfs
      run: |
        # Create proper initramfs structure
        mkdir -p ramdisk/{dev,proc,sys,system,data,vendor,sbin,bin,lib,etc,mnt,tmp}
        mkdir -p ramdisk/mnt/system
        
        # Copy busybox
        cp /bin/busybox ramdisk/bin/
        chmod +x ramdisk/bin/busybox
        
        # Create busybox symlinks
        cd ramdisk/bin
        for cmd in sh ash cat cp dd echo ls mkdir mount umount ln rm sleep switch_root; do
          ln -sf busybox $cmd
        done
        cd ../..
        
        # Also in sbin
        cd ramdisk/sbin
        for cmd in sh mount umount switch_root; do
          ln -sf ../bin/busybox $cmd
        done
        cd ../..
        
        # Create proper Halium init script
        cat > ramdisk/init << 'HALIUM_INIT'
#!/bin/sh
# Halium initramfs for NX669S

export PATH=/sbin:/bin:/usr/sbin:/usr/bin

# Mount essential filesystems
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev
mount -t tmpfs tmpfs /tmp

# Create device nodes if needed
[ -e /dev/null ] || mknod /dev/null c 1 3
[ -e /dev/console ] || mknod /dev/console c 5 1

# Wait for block devices
sleep 2

echo "Halium boot: NX669S"
echo "Mounting system partition..."

# Try to mount system (A/B device)
if [ -e /dev/block/by-name/system_a ]; then
    mount -o ro /dev/block/by-name/system_a /mnt/system
elif [ -e /dev/block/by-name/system ]; then
    mount -o ro /dev/block/by-name/system /mnt/system
elif [ -e /dev/block/mapper/system ]; then
    mount -o ro /dev/block/mapper/system /mnt/system
fi

# Check for Ubuntu Touch rootfs
if [ -d /mnt/system/ubuntu ]; then
    echo "Found Ubuntu Touch, switching root..."
    exec switch_root /mnt/system/ubuntu /sbin/init
fi

# Check for standard Linux rootfs
if [ -f /mnt/system/sbin/init ]; then
    echo "Found Linux rootfs, switching root..."
    exec switch_root /mnt/system /sbin/init
fi

# Fallback - drop to shell
echo "No rootfs found, dropping to shell..."
echo "Available block devices:"
ls -la /dev/block/by-name/ 2>/dev/null || ls /dev/block/
exec /bin/sh
HALIUM_INIT
        chmod +x ramdisk/init
        
        # Create fstab
        cat > ramdisk/etc/fstab << 'FSTAB'
# Halium fstab for NX669S
proc  /proc  proc  defaults  0  0
sysfs /sys   sysfs defaults  0  0
FSTAB

        # Show what we created
        echo "=== Ramdisk contents ==="
        find ramdisk -type f
        echo "=== Ramdisk size ==="
        du -sh ramdisk/
        
    - name: Build kernel
      run: |
        cd kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # Check available configs
        echo "=== Available vendor configs ==="
        ls arch/arm64/configs/vendor/ | grep -i lahaina | head -10
        
        # Use NX669S defconfig
        if [ -f arch/arm64/configs/vendor/lahaina-qgki_defconfig ]; then
          make O=out vendor/lahaina-qgki_defconfig
        else
          make O=out defconfig
        fi
        
        # Add Halium required configs
        cat >> out/.config << 'HALIUM_CONFIG'
CONFIG_VT=y
CONFIG_VT_CONSOLE=y
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
CONFIG_TMPFS=y
CONFIG_UNIX=y
CONFIG_SYSFS=y
CONFIG_PROC_FS=y
CONFIG_FHANDLE=y
CONFIG_NET=y
CONFIG_ANDROID_BINDER_IPC=y
CONFIG_ASHMEM=y
CONFIG_NAMESPACES=y
CONFIG_UTS_NS=y
CONFIG_IPC_NS=y
CONFIG_USER_NS=y
CONFIG_PID_NS=y
CONFIG_NET_NS=y
HALIUM_CONFIG
        
        # Build kernel
        make O=out -j$(nproc) Image
        
        echo "=== Kernel built ==="
        ls -la out/arch/arm64/boot/
        
    - name: Create Halium boot image
      run: |
        # Create ramdisk cpio
        echo "=== Creating ramdisk cpio ==="
        cd ramdisk
        find . | cpio -o -H newc 2>/dev/null | gzip > ../ramdisk.cpio.gz
        cd ..
        
        echo "=== Ramdisk size ==="
        ls -la ramdisk.cpio.gz
        
        # Get kernel
        KERNEL=kernel/out/arch/arm64/boot/Image
        echo "=== Kernel size ==="
        ls -la $KERNEL
        
        # Create boot.img with header v3 (Android 12)
        echo "=== Creating boot.img ==="
        python3 mkbootimg-tools/mkbootimg.py \
          --kernel $KERNEL \
          --ramdisk ramdisk.cpio.gz \
          --base 0x00000000 \
          --kernel_offset 0x00008000 \
          --ramdisk_offset 0x01000000 \
          --pagesize 4096 \
          --header_version 3 \
          --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 msm_rtb.filter=0x237 service_locator.enable=1 androidboot.usbcontroller=a600000.dwc3 swiotlb=0 loop.max_part=7 cgroup.memory=nokmem,nosocket androidboot.selinux=permissive androidboot.halium=1" \
          --os_version 12.0.0 \
          --os_patch_level 2024-01 \
          -o halium-boot-nx669s.img
        
        echo "=== Final boot.img ==="
        ls -la halium-boot-nx669s.img
        file halium-boot-nx669s.img
        
    - name: Upload Halium boot image
      uses: actions/upload-artifact@v4
      with:
        name: halium-boot-nx669s
        path: halium-boot-nx669s.img
        
    - name: Create Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: halium-boot-${{ github.run_number }}
        name: Halium Boot NX669S Build ${{ github.run_number }}
        files: halium-boot-nx669s.img
        body: |
          ## Halium Boot Image for Nubia Red Magic 6S Pro (NX669S)
          
          **Device:** NX669S (Red Magic 6S Pro)
          **SoC:** Snapdragon 888+ (lahaina)
          **Kernel:** ${{ github.event.inputs.kernel_branch || 'lineage-20' }}
          
          ### Flash Instructions
          ```bash
          # Test boot (temporary)
          fastboot boot halium-boot-nx669s.img
          
          # Permanent flash
          fastboot flash boot halium-boot-nx669s.img
          ```
          
          ### Notes
          - This boots the Halium kernel
          - Requires Ubuntu Touch system.img for full functionality
          - Will drop to shell if no rootfs found
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
